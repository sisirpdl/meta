Updated: Sep 20, 2024

In this chapter, we’ll take your WebXR experience to the next level by replacing the basic geometries we’ve used so far with detailed 3D models loaded from GLTF files. GLTF is a popular format for transmitting 3D models on the web because it’s compact, efficient, and easy to use in Three.js.

## Loading GLTF models

We’ll use the `GLTFLoader` from Three.js to load our 3D models. The models we’ll be using are a space station, a blaster, and a set of targets. Here’s how we load and set them up in the scene:

### Setting up the scene

```
<span><span>import</span><span>&nbsp;{</span><span>GLTFLoader</span><span>}&nbsp;</span><span>from</span><span>&nbsp;</span><span>'three/addons/loaders/GLTFLoader.js'</span><span>;</span></span><br><span><span></span></span><br><span><span>//&nbsp;global&nbsp;variables</span></span><br><span><span>const</span><span>&nbsp;blasterGroup&nbsp;=&nbsp;</span><span>new</span><span>&nbsp;</span><span>THREE</span><span>.</span><span>Group</span><span>();</span></span><br><span><span>const</span><span>&nbsp;targets&nbsp;=&nbsp;[];&nbsp;</span><span>//&nbsp;array&nbsp;to&nbsp;keep&nbsp;track&nbsp;of&nbsp;targets,&nbsp;we&nbsp;will&nbsp;need&nbsp;to</span><span>&nbsp;use&nbsp;this&nbsp;later</span></span><br><span><span></span></span><br><span><span>function</span><span>&nbsp;setupScene({scene,&nbsp;camera,&nbsp;renderer,&nbsp;player,&nbsp;cont</span><span>rollers})&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;</span><span>const</span><span>&nbsp;gltfLoader&nbsp;=&nbsp;</span><span>new</span><span>&nbsp;</span><span>GLTFLoader</span><span>();</span></span><br><span><span></span></span><br><span><span>&nbsp;&nbsp;</span><span>//&nbsp;Load&nbsp;the&nbsp;space&nbsp;station&nbsp;environment</span></span><br><span><span>&nbsp;&nbsp;gltfLoader.load(</span><span>'assets/spacestation.glb'</span><span>,&nbsp;gltf&nbsp;=&gt;&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;scene.add(gltf.scene);</span></span><br><span><span>&nbsp;&nbsp;});</span></span><br><span><span></span></span><br><span><span>&nbsp;&nbsp;</span><span>//&nbsp;Load&nbsp;the&nbsp;blaster&nbsp;model</span></span><br><span><span>&nbsp;&nbsp;gltfLoader.load(</span><span>'assets/blaster.glb'</span><span>,&nbsp;gltf&nbsp;=&gt;&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;blasterGroup.add(gltf.scene);</span></span><br><span><span>&nbsp;&nbsp;});</span></span><br><span><span></span></span><br><span><span>&nbsp;&nbsp;</span><span>//&nbsp;Load&nbsp;and&nbsp;clone&nbsp;the&nbsp;target&nbsp;models</span></span><br><span><span>&nbsp;&nbsp;gltfLoader.load(</span><span>'assets/target.glb'</span><span>,&nbsp;gltf&nbsp;=&gt;&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span>&nbsp;(</span><span>let</span><span>&nbsp;i&nbsp;=&nbsp;</span><span>0</span><span>;&nbsp;i&nbsp;&lt;&nbsp;</span><span>3</span><span>;&nbsp;i++)&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>const</span><span>&nbsp;target&nbsp;=&nbsp;gltf.scene.clone();</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//&nbsp;spawn&nbsp;targets&nbsp;at&nbsp;random&nbsp;locations&nbsp;in&nbsp;front&nbsp;of&nbsp;t</span><span>he&nbsp;player</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target.position.</span><span>set</span><span>(</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Math</span><span>.random()&nbsp;*&nbsp;</span><span>10</span><span>&nbsp;-&nbsp;</span><span>5</span><span>,</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;*&nbsp;</span><span>2</span><span>&nbsp;+&nbsp;</span><span>1</span><span>,</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-</span><span>Math</span><span>.random()&nbsp;*&nbsp;</span><span>5</span><span>&nbsp;-&nbsp;</span><span>5</span><span>,</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene.add(target);</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;targets.push(target);</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><br><span><span>&nbsp;&nbsp;});</span></span><br><span><span>}</span></span><br><span><span></span></span><br>
```

### Explanation:

-   **GLTFLoader**: We use `GLTFLoader` to load 3D models from GLTF files. Each model is loaded asynchronously, and once loaded, it’s added to the scene or another relevant group (like the blaster group).
    -   **Space station**: The space station model is added directly to the scene, providing an immersive environment for your WebXR experience. Here’s how it looks:
    
    ![Space station model](https://scontent.frca1-1.fna.fbcdn.net/v/t39.2365-6/460623525_1845676339290351_2635113316322839713_n.png?_nc_cat=105&ccb=1-7&_nc_sid=e280be&_nc_ohc=IE0Wx1sjs20Q7kNvwFoVWyt&_nc_oc=Adl-EFyBsS1QfFwrkiSxYzSrhhlsAxPoLV3qNa55ixWmrtteQHGI_8BlS42mHUQRxlI&_nc_zt=14&_nc_ht=scontent.frca1-1.fna&_nc_gid=c_aJrRWL8GPB-Tz-Mq6zlQ&oh=00_AfjWJ8A8ufSebHSMPNSJpNcBy2pggavKXxjETHBrUVUfOA&oe=6944059D)
    -   **Blaster**: We created the `blasterGroup` as an empty `THREE.Group` to house the blaster model. This way we can manipulate its transform right away without waiting for the blaster model to finish loading. The blaster model is added to the `blasterGroup`, which will be attached to the right controller when the user interacts with it. Here’s a glimpse of the blaster:
    
    ![Blaster model](https://scontent.frca1-1.fna.fbcdn.net/v/t39.2365-6/460657569_1845676365957015_9191477646709229916_n.png?_nc_cat=101&ccb=1-7&_nc_sid=e280be&_nc_ohc=GKclkqmNhlAQ7kNvwFNnAa3&_nc_oc=AdnUjJk4rg2yL-A1jJukR8g0KxYlMz36EfoqyFGF_X9XMvZys7mTSRLSiO3ijwUOR9s&_nc_zt=14&_nc_ht=scontent.frca1-1.fna&_nc_gid=c_aJrRWL8GPB-Tz-Mq6zlQ&oh=00_AfjyxiN4EWZj7RvWJ06YcS36KaznZfU9N58YS5XHLsnK-Q&oe=6943FED3)
    -   **Targets**: Three instances of the target model are created by cloning the original model. Each target is randomly positioned within the scene, providing dynamic and varied locations for the user to aim at. Here’s what it looks like:
    
    ![Target model](https://scontent.frca1-1.fna.fbcdn.net/v/t39.2365-6/460435200_1845676359290349_8656907630972025325_n.png?_nc_cat=103&ccb=1-7&_nc_sid=e280be&_nc_ohc=aAL7wU5V4d8Q7kNvwEe3w-Q&_nc_oc=AdlBV5x1NdYIT1sVg5jg-wuuYeOFv7ivdDNJn-v7KeWlcUFwomLCnJ0oGTpYPvKsVQg&_nc_zt=14&_nc_ht=scontent.frca1-1.fna&_nc_gid=c_aJrRWL8GPB-Tz-Mq6zlQ&oh=00_AfijhNyI09BCpI5ggeLIUgR4D_UtK6j3GHFFJMvYUBQtTA&oe=6943DE09)
    

## Attaching the blaster to the controller

The blaster model is attached to the right controller when it first comes alive (after entering VR). We do this in the `onFrame` function rather than `setupScene` because we need to wait for the controller to be active:

```
<span><span>function</span><span>&nbsp;onFrame(delta,&nbsp;time,&nbsp;{scene,&nbsp;camera,&nbsp;renderer,&nbsp;pl</span><span>ayer,&nbsp;controllers})&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;</span><span>if</span><span>&nbsp;(controllers.right)&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>const</span><span>&nbsp;{gamepad,&nbsp;raySpace,&nbsp;mesh}&nbsp;=&nbsp;controllers.right;</span></span><br><span><span></span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//&nbsp;Attach&nbsp;the&nbsp;blaster&nbsp;to&nbsp;the&nbsp;right&nbsp;controller</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>&nbsp;(!raySpace.children.includes(blasterGroup))&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raySpace.add(blasterGroup);</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mesh.visible&nbsp;=&nbsp;</span><span>false</span><span>;&nbsp;</span><span>//&nbsp;Hide&nbsp;the&nbsp;default&nbsp;controller&nbsp;model</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><br><span><span></span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//&nbsp;Firing&nbsp;bullets</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>&nbsp;(gamepad.getButtonClick(</span><span>XR_BUTTONS</span><span>.</span><span>TRIGGER</span><span>))&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//&nbsp;use&nbsp;the&nbsp;embedded&nbsp;bullet&nbsp;as&nbsp;prototype</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>const</span><span>&nbsp;bulletPrototype&nbsp;=&nbsp;blasterGroup.getObjectByName(</span><span>'bullet'</span><span>);</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span>&nbsp;(bulletPrototype)&nbsp;{</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>const</span><span>&nbsp;bullet&nbsp;=&nbsp;bulletPrototype.clone();</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scene.add(bullet);</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//&nbsp;copy&nbsp;position&nbsp;and&nbsp;quaternion&nbsp;directly&nbsp;from&nbsp;the&nbsp;</span><span>bulletPrototype,&nbsp;instead&nbsp;of&nbsp;from&nbsp;raySpace</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bulletPrototype.getWorldPosition(bullet.po</span><span>sition);</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bulletPrototype.getWorldQuaternion(bullet.</span><span>quaternion);</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>//&nbsp;...&nbsp;&nbsp;unchanged&nbsp;logic</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><br><span><span>&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><br><span><span>&nbsp;&nbsp;}</span></span><br><span><span>&nbsp;&nbsp;</span><span>//&nbsp;...&nbsp;&nbsp;unchanged&nbsp;logic</span></span><br><span><span>}</span></span><br><span><span></span></span><br>
```

### Explanation:

-   **Attaching the blaster**: The blaster model is attached to the right controller’s ray space. This is done in `onFrame` because the controller becomes active only after entering VR. Once attached, the default controller model is hidden by setting `mesh.visible = false`.
    -   **Embedded bullet prototype**: The bullet prototype is now embedded within the blaster model. This prototype serves two purposes: it acts as the base for cloning new bullets, and it serves as a marker from which we can read the starting position and orientation of each bullet. Here’s how it looks inside the blaster:
    
    ![Embedded bullet prototype](https://scontent.frca1-1.fna.fbcdn.net/v/t39.2365-6/460629765_1845676362623682_3517837049078239722_n.png?_nc_cat=103&ccb=1-7&_nc_sid=e280be&_nc_ohc=NE6kXGb_LXMQ7kNvwEX2mO0&_nc_oc=Adl1QVqbPZ2edWv9WC8m74xx_WbX-uqyiRi17FB5JxfQw--oepABuvT4ZG___T2GHRo&_nc_zt=14&_nc_ht=scontent.frca1-1.fna&_nc_gid=c_aJrRWL8GPB-Tz-Mq6zlQ&oh=00_Afg0VVwjIbBjkFueNv40T7TV8EuGgNXKu5-OEkK80ML5Eg&oe=6944076D)
    -   **Bullet firing**: When the trigger is pressed, a new bullet is cloned from the prototype, and its position and orientation are set to match the blaster. The bullet is then added to the scene and animated as described in previous chapters.
    

## Summary

In this chapter, you’ve replaced basic geometric shapes with detailed GLTF models, enhancing the realism and immersion of your WebXR experience. You’ve also attached the blaster model to the controller, allowing for a more integrated and interactive shooting experience. Additionally, the bullet prototype embedded in the blaster serves as both a cloning source and a position/orientation marker. In the next chapters, we’ll continue to build on this foundation by adding more complex interactions and gameplay elements.

Here’s what our scene looks like with the GLTF models:

![Scene with GLTF models](https://scontent.frca1-1.fna.fbcdn.net/v/t39.2365-6/460569033_1845676335957018_1081701925158155161_n.png?_nc_cat=110&ccb=1-7&_nc_sid=e280be&_nc_ohc=CRIAzYJeSKsQ7kNvwHtJR5I&_nc_oc=Adlc_ZiQMjIeVKgX_iZSXiQA7JHEOZwHjfI_XiOFRQ551WOY4nb7l_I26Vp69WvQB0s&_nc_zt=14&_nc_ht=scontent.frca1-1.fna&_nc_gid=c_aJrRWL8GPB-Tz-Mq6zlQ&oh=00_AfgkCraCRwayeE8TgBYHepBWeiPv6TdpEgKe3gL6OMDF7w&oe=694409BF)